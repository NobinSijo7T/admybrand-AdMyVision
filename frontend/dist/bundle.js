(()=>{class t{constructor(){this.ws=null,this.pc=null,this.localStream=null,this.isDetectionActive=!1,this.frameCount=0,this.detectionCount=0,this.clientId=this.generateClientId(),this.metrics={totalFrames:0,totalDetections:0,latencies:[],startTime:Date.now()},this.initializeElements(),this.setupEventListeners(),this.loadQRCode()}generateClientId(){return"client_"+Math.random().toString(36).substr(2,9)}initializeElements(){this.elements={startBtn:document.getElementById("startBtn"),stopBtn:document.getElementById("stopBtn"),exportMetricsBtn:document.getElementById("exportMetricsBtn"),status:document.getElementById("status"),remoteVideo:document.getElementById("remoteVideo"),overlay:document.getElementById("overlay"),qrCode:document.getElementById("qrCode"),connectionUrl:document.getElementById("connectionUrl"),fpsValue:document.getElementById("fpsValue"),latencyValue:document.getElementById("latencyValue"),detectionsValue:document.getElementById("detectionsValue"),framesValue:document.getElementById("framesValue"),detectionList:document.getElementById("detectionList")}}setupEventListeners(){this.elements.startBtn.addEventListener("click",()=>this.startDetection()),this.elements.stopBtn.addEventListener("click",()=>this.stopDetection()),this.elements.exportMetricsBtn.addEventListener("click",()=>this.exportMetrics()),setInterval(()=>this.updateMetricsDisplay(),1e3)}async loadQRCode(){try{const t=await fetch("/qr"),e=await t.json();this.elements.qrCode.innerHTML=`<img src="${e.qr_code}" alt="QR Code" style="max-width: 200px;">`,this.elements.connectionUrl.innerHTML=`<p><strong>URL:</strong> <a href="${e.url}" target="_blank">${e.url}</a></p>`}catch(t){console.error("Error loading QR code:",t),this.elements.qrCode.innerHTML="Error loading QR code"}}async startDetection(){try{this.updateStatus("Connecting...","disconnected"),await this.connectWebSocket(),this.isMobileDevice()&&await this.setupWebRTC(),this.isDetectionActive=!0,this.elements.startBtn.disabled=!0,this.elements.stopBtn.disabled=!1,this.updateStatus("Connected - Detection Active","connected")}catch(t){console.error("Error starting detection:",t),this.updateStatus("Connection Failed","disconnected")}}async stopDetection(){this.isDetectionActive=!1,this.ws&&this.ws.close(),this.pc&&this.pc.close(),this.localStream&&this.localStream.getTracks().forEach(t=>t.stop()),this.elements.startBtn.disabled=!1,this.elements.stopBtn.disabled=!0,this.updateStatus("Disconnected","disconnected")}async connectWebSocket(){return new Promise((t,e)=>{const s=`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}/ws/${this.clientId}`;this.ws=new WebSocket(s),this.ws.onopen=()=>{console.log("WebSocket connected"),t()},this.ws.onmessage=t=>{this.handleWebSocketMessage(JSON.parse(t.data))},this.ws.onerror=t=>{console.error("WebSocket error:",t),e(t)},this.ws.onclose=()=>{console.log("WebSocket disconnected"),this.updateStatus("Disconnected","disconnected")}})}async setupWebRTC(){try{this.localStream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480},facingMode:"environment"},audio:!1}),this.pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),this.localStream.getTracks().forEach(t=>{this.pc.addTrack(t,this.localStream)}),this.pc.onicecandidate=t=>{t.candidate&&this.sendWebSocketMessage({type:"ice_candidate",candidate:t.candidate})},this.pc.ontrack=t=>{this.elements.remoteVideo.srcObject=t.streams[0]};const t=await this.pc.createOffer();await this.pc.setLocalDescription(t),this.sendWebSocketMessage({type:"offer",offer:{type:t.type,sdp:t.sdp}}),this.startFrameCapture()}catch(t){throw console.error("Error setting up WebRTC:",t),t}}startFrameCapture(){if(!this.localStream)return;const t=document.createElement("video");t.srcObject=this.localStream,t.play();const e=document.createElement("canvas"),s=e.getContext("2d");t.onloadedmetadata=()=>{e.width=t.videoWidth,e.height=t.videoHeight;const i=setInterval(()=>{if(!this.isDetectionActive)return void clearInterval(i);s.drawImage(t,0,0);const n=e.toDataURL("image/jpeg",.8),o=`frame_${Date.now()}_${this.frameCount++}`,a=Date.now();this.sendWebSocketMessage({type:"frame",frame_id:o,capture_ts:a,frame_data:n}),this.metrics.totalFrames++},1e3/15)}}handleWebSocketMessage(t){switch(t.type){case"answer":this.handleWebRTCAnswer(t.answer);break;case"detection_results":this.handleDetectionResults(t.data);break;default:console.log("Unknown message type:",t.type)}}async handleWebRTCAnswer(t){this.pc&&await this.pc.setRemoteDescription(new RTCSessionDescription(t))}handleDetectionResults(t){try{const e=Date.now()-t.capture_ts;this.metrics.latencies.push(e),this.metrics.totalDetections+=t.detections.length,this.metrics.latencies.length>100&&(this.metrics.latencies=this.metrics.latencies.slice(-100)),this.displayDetections(t.detections),this.updateDetectionList(t.detections)}catch(t){console.error("Error handling detection results:",t)}}displayDetections(t){this.elements.overlay.innerHTML="";const e=this.elements.remoteVideo.getBoundingClientRect();this.elements.overlay.style.width=e.width+"px",this.elements.overlay.style.height=e.height+"px",t.forEach((t,s)=>{const i=this.getDetectionColor(t.label),n=t.xmin*e.width,o=t.ymin*e.height,a=(t.xmax-t.xmin)*e.width,c=(t.ymax-t.ymin)*e.height,r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.setAttribute("x",n),r.setAttribute("y",o),r.setAttribute("width",a),r.setAttribute("height",c),r.setAttribute("fill","none"),r.setAttribute("stroke",i),r.setAttribute("stroke-width","2");const l=document.createElementNS("http://www.w3.org/2000/svg","text");l.setAttribute("x",n),l.setAttribute("y",o-5),l.setAttribute("fill",i),l.setAttribute("font-size","14"),l.setAttribute("font-weight","bold"),l.textContent=`${t.label} (${Math.round(100*t.score)}%)`,this.elements.overlay.appendChild(r),this.elements.overlay.appendChild(l)})}updateDetectionList(t){const e=(new Date).toLocaleTimeString(),s=document.createElement("div");for(s.innerHTML=`\n            <strong>${e}:</strong> \n            ${t.map(t=>`${t.label} (${Math.round(100*t.score)}%)`).join(", ")||"No detections"}\n        `,this.elements.detectionList.insertBefore(s,this.elements.detectionList.firstChild);this.elements.detectionList.children.length>10;)this.elements.detectionList.removeChild(this.elements.detectionList.lastChild)}updateMetricsDisplay(){const t=(Date.now()-this.metrics.startTime)/1e3,e=this.metrics.totalFrames/t,s=this.metrics.latencies.length>0?this.metrics.latencies.reduce((t,e)=>t+e,0)/this.metrics.latencies.length:0;this.elements.fpsValue.textContent=e.toFixed(1),this.elements.latencyValue.textContent=Math.round(s),this.elements.detectionsValue.textContent=this.metrics.totalDetections,this.elements.framesValue.textContent=this.metrics.totalFrames}async exportMetrics(){try{const t=await fetch("/metrics/export",{method:"POST"});await t.json(),alert("Metrics exported to metrics/metrics.json")}catch(t){console.error("Error exporting metrics:",t),alert("Error exporting metrics")}}sendWebSocketMessage(t){this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify(t))}updateStatus(t,e){this.elements.status.textContent=t,this.elements.status.className=`status ${e}`}getDetectionColor(t){let e=0;for(let s=0;s<t.length;s++)e=t.charCodeAt(s)+((e<<5)-e);return`hsl(${Math.abs(e)%360}, 70%, 50%)`}isMobileDevice(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}}document.addEventListener("DOMContentLoaded",()=>{window.webrtcApp=new t})})();